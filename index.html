<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro</title>
    <link rel="stylesheet" href="bulma.min.css">
    <style>
        html::-webkit-scrollbar {
            display: none;
        }

        html {
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <main>
        <section class="hero is-fullheight">
            <nav class="hero-head">
                <header class="navbar">
                    <div class="container">
                        <div id="navbarMenuHeroC" class="navbar-menu is-active">
                            <div class="navbar-end">
                                <a id="setting_toggle" class="navbar-item">Configuraci贸n</a>
                            </div>
                        </div>
                    </div>
                </header>
            </nav>


            <div class="hero-body">
                <div class="container has-text-centered">
                    <p class="subtitle" id="state_"></p>
                    <p id="board" class="title">00:00</p>
                    <div class="section is-max-tablet is-max-desktop is-max-widescreen">
                        <button id="main_button" class="button is-primary"></button>
                    </div>
                </div>
            </div>

    </main>

    <div id="setting_modal" class="modal">
        <div id="modal_background" class="modal-background"></div>
        <form id="setting_form">

            <div class="modal-card">
                <header class="modal-card-head">
                    <p id="modal_title" class="modal-card-title">Setting</p>
                    <button id="quit_button_modal" class="delete" aria-label="close"></button>
                </header>
                <section class="modal-card-body">

                    <div class="field">
                        <label class="label">Pomodoro</label>
                        <div class="control">
                            <input class="input" type="number" placeholder="Text input" id="pomodoro_time"
                                name="pomodoro_time" value="25">
                        </div>
                    </div>

                    <div class="field">
                        <label id="short_break_modal_label" class="label">Short Break</label>
                        <div class="control">
                            <input class="input" type="number" placeholder="Text input" id="short_break"
                                name="short_break" value="5">
                        </div>
                    </div>

                    <div class="field">
                        <label id="long_break_modal_label" class="label">Long Break</label>
                        <div class="control">
                            <input class="input" type="number" placeholder="Text input" id="long_break"
                                name="long_break" value="15">
                        </div>
                    </div>

                    <div class="field">
                        <label id="long_break_interval_modal_label" class="label">Long Break interval</label>
                        <div class="control">
                            <input class="input" type="number" placeholder="Text input" id="long_break_interval"
                                name="long_break_interval" value="4">
                        </div>
                    </div>




                </section>
                <footer class="modal-card-foot">
                    <div class="buttons">
                        <button id="form_submit" type="submit" class="button is-success">Save changes</button>
                        <button id="cancel_button_modal" type="button" class="button">Cancel</button>
                    </div>

                </footer>
        </form>
    </div>
    </div>

    <script src="i18next.min.js"></script>
    <script>
        i18next.init({
            lng: navigator.language.split('-')[0],
            resources: {
                en: {
                    translation: {
                        start: "Start",
                        pomodoro: "Pomodoro",
                        setting: "Setting",
                        pause: "Pause",
                        resume: "Resume",
                        long_break: "Long Break",
                        short_break: "Short Break",
                        long_break_interval: "Long Break interval",
                        save_changes: "Save Changes",
                        cancel: "Cancel",
                        save_setting_error_message: "To change the application settings, the timer must be stopped.",

                    }
                },
                es: {
                    translation: {
                        start: "Empezar",
                        pomodoro: "Pomodoro",
                        setting: "Configuraci贸n",
                        pause: "Pausar",
                        resume: "Continuar",
                        long_break: "Descanso largo",
                        short_break: "Descanso Corto",
                        long_break_interval: "Intervalo de descanso largo",
                        save_changes: "Guardar cambios",
                        cancel: "Cancelar",
                        save_setting_error_message: "Para cambiar la configurci贸n de la aplicaci贸n, el temporizador tine que estar detenido.",

                    }
                }
            }
        });

        const MS_PER_MINUTE = 60_000
        const MS_VALUE = 1_000
        const MIN_VALUE = 60
        const board = document.querySelector("#board")
        const button = document.querySelector("#main_button")
        const state = document.querySelector("#state_")
        button.addEventListener("click", handleButton)
        const settingForm = document.querySelector("#setting_form")
        settingForm.addEventListener("submit", handleSettingForm)

        const APP_STATES = {
            STOPPED: 0,
            PAUSED: 1,
            POMODORO: 2,
        };


        const CHANGE_TO = {
            POMODORO: 0,
            LONG_BREAK: 1,
            SHORT_BREAK: 2
        }

        let appConfig = {
            longBreak: 15 * MS_PER_MINUTE,
            pomodoroTime: 25 * MS_PER_MINUTE,
            shortBreak: 5 * MS_PER_MINUTE,
            pomodoroTimes: 4,
        }
        let changeTo = CHANGE_TO.SHORT_BREAK
        let appState = APP_STATES.STOPPED
        const pomodoreTimes = 0
        let timer = null
        let pomodoroTime = appConfig.pomodoroTime
        let pomodoroCount = 0
        let restartPomodoro = false
        const audio = new Audio("sound_sfx.wav")

        function initApp() {
            state.innerText = i18next.t("pomodoro")
            button.innerText = i18next.t("start")
            document.querySelector("#setting_toggle").innerText = i18next.t("setting")
            document.querySelector("#form_submit").innerText = i18next.t("save_changes")
            document.querySelector("#cancel_button_modal").innerText = i18next.t("cancel")
            document.querySelector("#modal_title").innerText = i18next.t("setting")
            document.querySelector("#short_break_modal_label").innerText = i18next.t("short_break")
            document.querySelector("#long_break_modal_label").innerText = i18next.t("long_break")
            document.querySelector("#long_break_interval_modal_label").innerText = i18next.t("long_break_interval")

            document.querySelector("#quit_button_modal").addEventListener("click", hideSettingModal)
            document.querySelector("#cancel_button_modal").addEventListener("click", hideSettingModal)
            document.querySelector("#modal_background").addEventListener("click", hideSettingModal)
            document.querySelector("#setting_toggle").addEventListener("click", showSettingModal)
            updateBoard(appConfig.pomodoroTime)
        }

        function formatMillisecondsToTime(ms) {
            let totalSeconds = Math.floor(ms / MS_VALUE)
            let minutes = Math.floor(totalSeconds / MIN_VALUE)
            let seconds = totalSeconds % MIN_VALUE
            const pad = (num) => String(num).padStart(2, '0')
            return `${pad(minutes)}:${pad(seconds)}`
        }

        function parseToInteger(value) {
            return parseInt(value)
        }

        function updateBoard(time) {
            board.innerText = formatMillisecondsToTime(time)
        }

        function validateEndPomodore(time) {
            if (time === 0) {
                clearInterval(timer)
                button.innerText = i18next.t("start")
                audio.play()

                switch (changeTo) {
                    case CHANGE_TO.SHORT_BREAK:
                        state.innerText = i18next.t("short_break")
                        pomodoroTime = appConfig.shortBreak
                        updateBoard(appConfig.shortBreak)
                        changeTo = CHANGE_TO.POMODORO
                        pomodoroCount += 1
                        break

                    case CHANGE_TO.LONG_BREAK:
                        state.innerText = i18next.t("long_break")
                        pomodoroTime = appConfig.longBreak
                        updateBoard(appConfig.longBreak)
                        changeTo = CHANGE_TO.POMODORO
                        restartPomodoro = true
                        break

                    case CHANGE_TO.POMODORO:
                        state.innerText = i18next.t("pomodoro")
                        pomodoroTime = appConfig.pomodoroTime
                        updateBoard(appConfig.pomodoroTime)
                        console.log(pomodoroCount, appConfig.pomodoroTimes)
                        if (pomodoroCount >= appConfig.pomodoroTimes - 1) {
                            changeTo = CHANGE_TO.LONG_BREAK
                        }
                        else changeTo = CHANGE_TO.SHORT_BREAK
                        break
                }
                appState = APP_STATES.STOPPED
            }
        }



        function getInterval() {
            return setInterval(() => {
                updateBoard(pomodoroTime)
                validateEndPomodore(pomodoroTime)
                if (pomodoroTime > 0) {
                    pomodoroTime -= MS_VALUE
                }
            }, MS_VALUE)
        }


        function startPomodore() {
            if (restartPomodoro) {
                pomodoroCount = 0
                restartPomodoro = false
            }
            appState = APP_STATES.POMODORO
            button.innerText = i18next.t("pause")
            timer = getInterval()
        }


        function pausePomodore() {
            clearInterval(timer)
            button.innerText = i18next.t("resume")
            appState = APP_STATES.PAUSED
        }

        function resumePomodore() {
            timer = getInterval()
            button.innerText = i18next.t("pause")
            appState = APP_STATES.POMODORO
        }

        function handleButton(_even) {
            console.log(appState)
            switch (appState) {
                case APP_STATES.STOPPED:
                    startPomodore()
                    break;

                case APP_STATES.PAUSED:
                    resumePomodore()
                    break;

                case APP_STATES.POMODORO:
                    pausePomodore()
                    break;
            }

        }

        function updateSetting() {
            if (appState === APP_STATES.STOPPED) {
                pomodoroTime = appConfig.pomodoroTime
                updateBoard(pomodoroTime)
            }
        }

        function handleSettingForm(event) {
            event.preventDefault()
            if (appState !== APP_STATES.STOPPED) {
                alert(i18next.t("save_setting_error_message"))
            }
            else {
                const formData = new FormData(event.target)
                const setting = Object.fromEntries(formData.entries())
                appConfig.longBreak = setting.long_break * MS_PER_MINUTE
                appConfig.shortBreak = setting.short_break * MS_PER_MINUTE
                appConfig.pomodoroTime = setting.pomodoro_time * MS_PER_MINUTE
                appConfig.pomodoroTimes = parseToInteger(setting.long_break_interval)
                updateSetting()
                hideSettingModal()
            }
        }

        function showSettingModal() {
            document.querySelector("#setting_modal").classList.add("is-active")
        }

        function hideSettingModal() {
            document.querySelector("#setting_modal").classList.remove("is-active")
        }

        initApp()

    </script>
</body>

</html>